@page
@model simple_chat_csharp.Pages.IndexModel
@{
    ViewData["Title"] = "Chat";
}

<style>
    #chat { max-width: 500px; margin: auto; text-align: center; }
    #messages { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    #messages li { padding: 5px; border-bottom: 1px solid #ddd; }
    input { width: 90%; margin: 5px; padding: 8px; }
    button { padding: 8px 15px; cursor: pointer; }
</style>

<div id="chat">
    <ul id="messages"></ul>
    <input type="text" id="userInput" placeholder="Your name" />
    <input type="text" id="messageInput" placeholder="Type a message" />
    <button id="sendButton" disabled>Send</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .build();

    connection.on("ReceiveMessage", (user, message) => {
        const li = document.createElement("li");
        li.textContent = `${user}: ${message}`;
        document.getElementById("messages").appendChild(li);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight; // Auto-scroll
    });

    connection.start()
        .then(() => connection.invoke("LoadMessages")) // Carrega mensagens antigas
        .catch(err => console.error(err.toString()));

    document.getElementById("sendButton").addEventListener("click", sendMessage);
    document.getElementById("messageInput").addEventListener("keypress", event => {
        if (event.key === "Enter") sendMessage();
    });

    function sendMessage() {
        const user = document.getElementById("userInput").value.trim();
        const message = document.getElementById("messageInput").value.trim();
        
        if (!user || !message) return;

        connection.invoke("SendMessage", user, message).catch(err => console.error(err.toString()));
        document.getElementById("messageInput").value = ""; // Limpa campo após envio
        document.getElementById("sendButton").disabled = true;
    }

    document.getElementById("messageInput").addEventListener("input", () => {
        document.getElementById("sendButton").disabled = !document.getElementById("messageInput").value.trim();
    });
</script>
